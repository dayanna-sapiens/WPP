@model WPP.Model.ModuloOperacionRecoleccion.OTRModel
@{
    //string tipoOTR = ViewBag.TipoOTR;
    ViewBag.Title = "OTR" + Model.Tipo;
    Layout = "~/Views/Shared/_Layout.cshtml";

}


<div class="row" style="margin-top:20px; ">
    <br />
    <h3>Planificar OTR @Model.Tipo</h3>
    <br />
    <div class="col-md-6" style="padding-right:30px;">
        <div class="row" id="divRowRutas">
            <div class="col-12-md">
                <label class="col-md-2">Ruta </label>
            </div>
            <br />
            <div class="col-12-md">

                <br />
                <div class="table-responsive" style="height:400px; overflow-y:auto">
                    <table class="table table-hover" id="tabla-viajes">
                        <thead>
                            <tr>
                                <th>
                                    Cliente
                                </th>
                                <th>
                                    Contrato
                                </th>
                                <th>
                                    Ubicación
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tblViajes"></tbody>
                    </table>
                </div>

            </div>
        </div>
        <div class="row" id="divRowOTR" style="display:none">
            <div class="col-12-md">
                <label class="col-md-10">OTRs Activas </label>
            </div>
            <br />
            <div class="col-12-md">
                <br />
                <div class="table-responsive" style="height:400px; overflow-y:auto">
                    <table class="table table-hover" id="tabla-otr">
                        <thead>
                            <tr>
                                <th>
                                    
                                </th>
                                <th>
                                    OTR
                                </th>
                                <th>
                                    Fecha
                                </th>
                                <th>
                                    Equipo
                                </th>
                            </tr>
                        </thead>
                        <tbody id="tblOTR"></tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    <div class="col-md-6">
        @using (Html.BeginForm("CrearOTR", "OTR", FormMethod.Post, new { id = "frmCrear", @class = "form-horizontal" }))
        {
            @Html.ValidationSummary(true)
            @Html.HiddenFor(m => m.Tipo)

            <div class="form-group">
                <label class="col-md-2">No OTR </label>
                <div class="col-md-4">
                    @Html.TextBoxFor(m => m.Consecutivo, new { @Class = "form-control", id = "Consecutivo", @readonly = "readonly" })
                    @Html.ValidationMessageFor(m => m.Consecutivo)
                </div>
                <label class="col-md-2">Fecha  <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-4">
                    @Html.TextBoxFor(m => m.Fecha, "{0:dd/MM/yyyy}", new { @Class = "form-control", id = "Fecha", @readonly = "readonly" })
                    @Html.ValidationMessageFor(m => m.Fecha)
                </div>
            </div>

            <div class="form-group">
                <label class="col-md-2">Estado </label>
                <div class="col-md-4">
                    @Html.TextBoxFor(m => m.Estado, new { @Class = "form-control", id = "Estado", @readonly = "readonly" })
                    @Html.ValidationMessageFor(m => m.Estado)
                </div>
                <label class="col-md-2">Equipo <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-4">
                    @Html.TextBoxFor(m => m.NombreEquipo, new { @Class = "form-control", id = "NombreEquipo" })
                    @Html.ValidationMessageFor(m => m.NombreEquipo)
                    @Html.HiddenFor(m => m.Equipo)
                </div>
            </div>
        <div class="form-group">
            <label class="col-md-2">Origen <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
            <div class="col-md-4">
                @Html.DropDownListFor(m => m.Origen, new SelectList(ViewBag.ListaRellenos, "Id", "Nombre"), String.Empty, new { @class = "form-control", id = "Origen" })
                @Html.ValidationMessageFor(m => m.Origen)
            </div>
            <label class="col-md-2" style="padding-right:8px;">Destino <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
            <div class="col-md-4">
                @Html.DropDownListFor(m => m.Destino, new SelectList(ViewBag.ListaRellenos, "Id", "Nombre"), String.Empty, new { @class = "form-control", id = "Destino" })
                @Html.ValidationMessageFor(m => m.Destino)
            </div>
        </div>
        <div class="form-group">
            <label class="col-md-2" style="padding-right:8px;">Relleno <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
            <div class="col-md-10">
                @Html.DropDownListFor(m => m.Relleno, new SelectList(ViewBag.ListaRellenos, "Id", "Nombre"), String.Empty, new { @class = "form-control", id = "Relleno" })
                @Html.ValidationMessageFor(m => m.Relleno)
            </div>
        </div>
            <div class="form-group">
                <label class="col-md-2" style="padding-right:0px;">Cliente <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-10">
                    @Html.DropDownListFor(m => m.Cliente, new SelectList(ViewBag.ListaClientes, "Id", "Nombre"), String.Empty, new { @class = "form-control", id = "Cliente" })
                    @Html.ValidationMessageFor(m => m.Cliente)
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2" style="padding-right:0px;">Contrato <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-10">
                    @Html.DropDownListFor(m => m.Contrato, new SelectList(ViewBag.ListaContratos, "Id", "DescripcionContrato"), String.Empty, new { @class = "form-control", id = "Contrato" })
                    @Html.ValidationMessageFor(m => m.Contrato)
                </div>
            </div> 
            <div class="form-group" id="divRutaRecoleccion">
                <label class="col-md-4" style="padding-right:0px;">Ruta Recolección <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-8">
                    @Html.DropDownListFor(m => m.RutaRecoleccion, new SelectList(ViewBag.ListaRutaRecoleccion, "Id", "Descripcion"), String.Empty, new { @class = "form-control", id = "RutaRecoleccion" })
                    @Html.ValidationMessageFor(m => m.RutaRecoleccion)
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-2" style="padding-right:0px;">Cuadrilla <span title="Este campo es requerido" style="font-size:x-small" class="glyphicon glyphicon-asterisk" aria-hidden="true"></span></label>
                <div class="col-md-10">
                    @Html.DropDownListFor(m => m.Cuadrilla, new SelectList(ViewBag.ListaCuadrilla, "Id", "Descripcion"), String.Empty, new { @class = "form-control", id = "Cuadrilla" })
                    @Html.ValidationMessageFor(m => m.Cuadrilla)
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-3" style="padding-right:0px;">Observaciones</label>
                <div class="col-md-12">
                    @Html.TextAreaFor(m => m.Observaciones, new { @class = "form-control", id = "Observaciones" })
                    @Html.ValidationMessageFor(m => m.Observaciones)
                </div>
            </div>
            <button id="btnSubmit" type="submit" class="btn btn-primary" style="display:none">Submmit</button>
            <a id="btnGuardar" class="btn btn-primary">Guardar</a>
            @*<a id="btnCobrar" class="btn btn-primary" style="display:none;">Imprimir</a>*@
            @Html.ActionLink("Cancelar", "Index", "OTR", null, new { @Class = "btn btn-primary" })

        }
    </div>
</div>



<script language="javascript" type="text/javascript">

    $(document).ready(function () {

        jQuery.validator.methods.date = function (value, element) {
            var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            var isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
            if (isSafari || isChrome) {
                var d = new Date();
                return this.optional(element) || !/Invalid|NaN/.test(new Date(d.toLocaleDateString(value)));
            } else {
                return this.optional(element) || !/Invalid|NaN/.test(new Date(value));
            }
        };

        // Función para dar formato numérico
        Number.prototype.format = function (n, x) {
            var re = '\\d(?=(\\d{' + (x || 3) + '})+' + (n > 0 ? '\\.' : '$') + ')';
            return this.toFixed(Math.max(0, ~~n)).replace(new RegExp(re, 'g'), '$&,');
        };


        var tipo = $("#Tipo").val();
        //if (tipo == "Municipal") {
        //    $("#divMadre").hide();
        //}
        //else {
        //    $("#divMadre").show();
        //}

        // Se incializa el valor de algunas variables;

        var today = new Date();
        $('#Fecha').datepicker({
            format: 'dd/mm/yyyy',
            changeYear: true,
            startDate: new Date(today.getFullYear(), today.getMonth(), today.getDate())
        });

        $('#Estado').val("Activo");

 
        // Autocomplete del Equipo
        $("#NombreEquipo").autocomplete({
            source: "../Equipo/AutoCompleteEquipo",
            minLength: 1,
            select: function (event, ui) {
                console.log(JSON.stringify(ui));
                $("#Equipo").val(ui.item.id);
                $("#NombreEquipo").val(ui.item.value);
            }
        });
     
        //// Si se indica que es una OTR madre se deshabilita la ruta de recoleccion, se oculta la tabla de rutas y se muestra la tabla de OTRs,
        //// de lo contrario se oculta la tabla de OTRs y se muestra la tabla de rutas y se habilita la parte de rutas de recoleccion
        //$("input:radio[name='madre']").change(function () {
        //    actual = $("#OTRMadre").val();
        //    append = $(this).val();
        //    if ($(this).is(":checked")) {
        //        actual = append;
        //        $("#OTRMadre").val(actual == "0" ? false : true);
        //        if (actual == "0")
        //        {
        //            $("#divRutaRecoleccion").show();
        //            $("#divRowRutas").show();
        //            $("#divRowOTR").hide();                    
        //        }
        //        else
        //        {
        //            $("#divRutaRecoleccion").hide();
        //            $("#divRowRutas").hide();
        //            $("#divRowOTR").show();
        //            CargarOTRs();
        //        }

        //    } else {
        //        $("#OTRMadre").val(false);
        //    }
        //});

        // Onchange del cliente para poder llenar los contratos segun el cliente seleccionado
        $("#Cliente").change(function () {
            CargarContratos();
        });



    });// end document ready

    // Se guarda la informacion de la OTR y se valida que la informacion requerida haya sido completada
    $("#btnGuardar").click(function () {

        var equipo = $("#Equipo").val();
        if (equipo == "" || equipo == null || equipo == "0") {
            var errorArray = {};

            errorArray["NombreEquipo"] = 'Equipo inválido';

            $('#frmCrear').validate().showErrors(errorArray);
        }
        else {//$("#OTRMadre").val() == "False" &&
            if ($("#RutaRecoleccion").val() == "") {
                var errorArray = {};

                errorArray["RutaRecoleccion"] = 'Debe seleccionar la ruta de recolección';

                $('#frmCrear').validate().showErrors(errorArray);
            }
            else {

                $.ajax({
                    url: '/OTR/CrearOTR',
                    data: $('#frmCrear').serializeArray(),
                    type: 'POST',
                    success: function (data) {
                        if(data!=null)
                        {                            
                            window.open("/OTR/ReporteOTR?id=" + data, 'mywindow', 'fullscreen=yes, scrollbars=auto');
                        }
                        else
                        {

                        }
                    },
                    error: function (xhr, textStatus, errorThrown) {                        
                    },
                    traditional: true
                });

            //    document.getElementById("btnSubmit").click();



                //if ($("#OTRMadre").val() == "False")
                //{
                  //  document.getElementById("btnSubmit").click();
                //}
                //else {
                //    CargarOTRHijas();
                //    if ($("#OTRHijas").val() == "") {
                //        swal("", "Debe seleccionar al menos una OTR activa", "error");
                //        //alert("Debe seleccionar al menos una OTR activa");
                //    }
                //    else {
                //        document.getElementById("btnSubmit").click();
                //    }

                //}
            }
        }
    });

    // Se obtienen los puntos que componen la ruta de recoleccion seleccionada
    $("#RutaRecoleccion").change(function () {
        var busqueda = $("#RutaRecoleccion").val();
        var path = "/RutaRecoleccion/CargarRutasRecoleccion?ruta=" + busqueda;
        $.ajax({
            type: 'POST',
            url: path,
            success: function (data) {
                if (data != null) {
                    CargarRutas(data);
                }
                else {
                    $("#tblViajes tr").remove();
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $("#tblViajes tr").remove();
            },
            traditional: true

        });
    });

    // Se crea la tabala de puntos de ruta de recoleccion con la informacion recuperada
    function CargarRutas(data) {
        $("#tblViajes tr").remove();

        var tabla = $("#tblViajes")[0];

        for (var i = 0; i < data.length; i++) {

            var row = document.createElement("tr");
            row.id = data[i].Id;

            // ID del producto del contrato
            var id = document.createElement("td");
            id.innerText = data[i].Id;
            id.innerHTML = data[i].Id;
            id.style.display = "none";
            row.appendChild(id);

            // Nombre del cliente
            var cliente = document.createElement("td");
            cliente.innerText = data[i].Descripcion;
            cliente.innerHTML = data[i].Descripcion;
            row.appendChild(cliente);

            // Nombre del contrato
            var contrato = document.createElement("td");
            contrato.innerText = data[i].ContratoDescripcion;
            contrato.innerHTML = data[i].ContratoDescripcion;
            row.appendChild(contrato);

            // Ubicacion
            var ubicacion = document.createElement("td");
            ubicacion.innerText = data[i].UbicacionDescripcion;
            ubicacion.innerHTML = data[i].UbicacionDescripcion;
            row.appendChild(ubicacion);

            tabla.appendChild(row);


        }
    }

    // Se cargan todas las OTR pendientes segun el tipo de OTR 
    function CargarOTRs() {
        var busqueda = $("#Tipo").val();
        var path = "/OTR/CargarListaOTR?tipo="+busqueda;
        $.ajax({
            type: 'POST',
            url: path,
            success: function (data) {
                if (data != null) {
                    CargarListaOTR(data);
                }
                else {
                    $("#tblOTR tr").remove();
                }
            },
            error: function (xhr, textStatus, errorThrown) {
                $("#tblOTR tr").remove();
            },
            traditional: true

        });
    }

    // Se crea la tabla de OTRs con la informacion obtenida
    function CargarListaOTR(data) {
        $("#tblOTR tr").remove();

        var tabla = $("#tblOTR")[0];

        for (var i = 0; i < data.length; i++) {

            var row = document.createElement("tr");
            row.id = data[i].Id;

            var checkbox = document.createElement('input');
            checkbox.type = "checkbox";
            checkbox.name = data[i].Id;
            checkbox.id = data[i].Id;
            row.appendChild(checkbox);

            // ID del producto del contrato
            var id = document.createElement("td");
            id.innerText = data[i].Id;
            id.innerHTML = data[i].Id;
            id.style.display = "none";
            row.appendChild(id);

            // Consecutivo OTR
            var consecutivo = document.createElement("td");
            consecutivo.innerText = data[i].Consecutivo;
            consecutivo.innerHTML = data[i].Consecutivo;
            row.appendChild(consecutivo);

            // Fecha
            var stringFecha = data[i].Fecha;
            stringFecha = stringFecha.substring(6, 19);
            var date = new Date(Number(stringFecha));
            var fecha = document.createElement("td");
            fecha.innerText = convertDate(date);
            fecha.innerHTML = convertDate(date);
            row.appendChild(fecha);

            // Equipo
            var equipo = document.createElement("td");
            equipo.innerText = data[i].NombreEquipo;
            equipo.innerHTML = data[i].NombreEquipo;
            row.appendChild(equipo);

            tabla.appendChild(row);


        }
    }

    function convertDate(inputFormat) {
        function pad(s) { return (s < 10) ? '0' + s : s; }
        var d = new Date(inputFormat);
        return [pad(d.getDate()), pad(d.getMonth() + 1), d.getFullYear()].join('/');
    }

    // Se obtiene las OTR hijas que fueron seleccionada y se llena un json con esta informacion 
    // esto con el fin de guardar dicha informacion
    //function CargarOTRHijas() {
    //    var tabla = $("#tblOTR")[0];
    //    var idHijas = "";
    //    for (var i = 0; i < tabla.childElementCount; i++) {
    //        var row = tabla.children[i];

    //        var check = row.children[0];
    //        if (check.checked)
    //        {
    //            if (i == 0) {
    //                idHijas += row.children[1].innerText;
    //            }
    //            else {
    //                idHijas += "," + row.children[1].innerText;
    //            }
    //        }
    //    }
    //    $("#OTRHijas").val(idHijas);
    //}

    // Carga el dropdown de contratos segun el cliente seleccionado
    function CargarContratos() {
        var cliente = $("#Cliente").val();
        var path = "/Contrato/CargarContratos?idCliente=" + cliente;
        $.ajax({
            type: 'POST',
            url: path,
            success: function (data) {
                populateDD('Contrato', data, "Contrato");

            },
            error: function (xhr, textStatus, errorThrown) {
                $("#Contrato").empty();
            },
            traditional: true

        });
    }

    // Funcion para llenar de manera dinámica el dropdown de contratos
    function populateDD(_idPopulate, data, tipo) {
        var dd = $("#" + _idPopulate);
        dd.empty();
        dd.append($('<option></option>').val("").html(""));
        for (var i = 0; i < data.length; i++) {

            dd.append($('<option></option>').val(data[i].Id).html(data[i].DescripcionContrato));

        }
    }

 
</script>